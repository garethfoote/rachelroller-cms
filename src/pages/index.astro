---
import Welcome from '../components/Welcome.astro';
import Layout from '../layouts/Layout.astro';
import ProjectCard from '../components/ProjectCard.astro';

import { getEntry } from 'astro:content';
import { getCollection } from 'astro:content';

const home = await getEntry('pages', 'home');
if (!home) throw new Error('Missing homepage content at src/content/pages/home.md');
const { Content, headings } = await home.render();
const { title, intro } = home.data;

// const projects = await getCollection('projects', ({ data }) => !data.draft);
const projects = (await getCollection('projects', ({ data }) => !data.draft))
  .sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());
---

<Layout pageTitle={title}>
  <div class="flex lg:h-screen min-h-screen p-3 lg:overflow-hidden">
    <header 
      id="mobileSheet"
      style="--handle-h: 3rem;"
      class="flex-none
        pt-3 px-3 border-gray-200
        md:pt-0 md:pr-3 md:pl-0 md:sticky md:top-0 md:w-1/4 md:min-w-[200px] md:border-r
        fixed bottom-0 left-0 w-full bg-white
        transition-transform duration-300 ease-out will-change-transform
        translate-y-[calc(100%-var(--handle-h))] md:translate-y-0
        z-40">
        <button
          id="mobileSheetToggle"
          class="md:hidden absolute w-full h-5"
          aria-controls="mobileSheetBody"
          aria-expanded="false"
        >
          <span class="sr-only">Reveal</span>
          <span
            id="arrowIcon"
            aria-hidden="true"
            class="transition-transform duration-300 select-none absolute left-[-5px] top-0 rotate-90"
          >
            ‚Üê
          </span>
        </button>

       <!-- Sheet content -->
      <div id="mobileSheetBody" class="px-3 pb-5 md:px-0 md:pb-0">
        <Welcome title={title} intro={intro} />
        <Content />
      </div>
    </header>
    <div
      id="mobileSheetBackdrop"
      class="fixed inset-0 bg-black/30 opacity-0 pointer-events-none transition-opacity z-30 md:hidden"
    ></div>
    <main class="min-w-0 flex-1 px-0 md:px-3 lg:h-screen lg:overflow-y-auto">
      <div class="w-full max-w-full lg:max-w-[60%]">
        <h2 class="heading">Work</h2>
        <ul class="grid">
          {projects.map(p => (
            <li>  
              <ProjectCard
                project={p}
              />
            </li>
          ))}
        </ul>
      </div>
    </main>
  </div>
</Layout>


<script is:inline>
  const sheet = document.getElementById('mobileSheet');
  const toggle = document.getElementById('mobileSheetToggle');
  const backdrop = document.getElementById('mobileSheetBackdrop');

  const collapsed = 'translate-y-[calc(100%-var(--handle-h))]';
  const expanded  = 'translate-y-0';

  const arrow = document.getElementById('arrowIcon');

  function setOpen(isOpen) {
    sheet.classList.toggle(expanded, isOpen);
    sheet.classList.toggle(collapsed, !isOpen);
    toggle.setAttribute('aria-expanded', String(isOpen));

    // flip arrow
    arrow.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';

    backdrop.classList.toggle('opacity-100', isOpen);
    backdrop.classList.toggle('pointer-events-auto', isOpen);
    document.documentElement.classList.toggle('overflow-hidden', isOpen);
  }

  // ensure both classes exist so Tailwind generates them
  sheet.classList.add(collapsed);

  toggle.addEventListener('click', () => {
    const isOpen = !sheet.classList.contains(expanded);
    setOpen(isOpen);
  });

  backdrop.addEventListener('click', () => setOpen(false));

  // Close on Esc
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') setOpen(false);
  });
</script>