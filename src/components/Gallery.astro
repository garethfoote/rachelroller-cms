---
interface Props {
  images: string[];
  id: string;
  perPage?: number;
  alt?: string;
}
const { images, id, perPage = 1, alt = '' } = Astro.props as Props;
---

<section
  id={id}
  class="splide pb-3"
  data-gallery-id={id}
  data-per-page={perPage}
  aria-label="Image gallery"
>
  <div class="splide__track">
    <ul class="splide__list">
      {images.map((src) => (
        <li class="splide__slide">
          <img src={src} alt={alt} loading="lazy" decoding="async" />
        </li>
      ))}
    </ul>
  </div>
</section>

<style>
  .splide__slide img { display:block; width:100%; height:auto; }
</style>

<script>
  import Splide from '@splidejs/splide';
  import '@splidejs/splide/css/core';

  // Support multiple galleries on the same page:
    const nodes = document.querySelectorAll<HTMLElement>('.splide[data-gallery-id]');
    nodes.forEach((root) => {
    const perPageAttr =
      parseInt(root.getAttribute('data-per-page') || '1', 10) || 1;

    const splide = new Splide(root, {
      type: 'loop',
      pagination: false,
      arrows: false,
      perPage: perPageAttr,
      perMove: 1,
      gap: '0.75rem',
      focus: 'center',
      omitEnd: true,
      breakpoints: {
        640: { perPage: 1, gap: '0.5rem' },
        1024: { perPage: perPageAttr }
      }
    });
    splide.mount();

    // --- Tap left/right to go prev/next (ignores drags and long presses) ---
    let startX = 0, startY = 0, startT = 0;
    const TAP_DIST = 10;   // px
    const TAP_TIME = 300;  // ms

    root.addEventListener('pointerdown', (e) => {
      startX = e.clientX; startY = e.clientY; startT = performance.now();
    }, { passive: true });

    root.addEventListener('pointerup', (e) => {
      // ignore if the user interacted with controls/links/buttons inside the slide
      const t = e.target as HTMLElement;
      if (t.closest('a, button, [data-no-tap]')) return;

      const dist = Math.hypot(e.clientX - startX, e.clientY - startY);
      const dt = performance.now() - startT;
      if (dist > TAP_DIST || dt > TAP_TIME) return; // it was a drag or long press

      const rect = root.getBoundingClientRect();
      const mid = rect.left + rect.width / 2;
      if (e.clientX > mid) splide.go('>'); else splide.go('<');
    });

    // Optional: keyboard left/right when the gallery is focused
    root.tabIndex = 0;
    root.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') { e.preventDefault(); splide.go('>'); }
      if (e.key === 'ArrowLeft')  { e.preventDefault(); splide.go('<'); }
    });
  });
</script>
